<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GuardianTix</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user/homepage.css') }}">
</head>
<body>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Navigasi -->
    <nav>
      <div class="logo">GuardianTix</div>
      <div id="authSection" class="user-info">
        {% if session.get('username') %}
          Halo, {{ session['username'] }} |
          <a href="{{ url_for('homepage') }}">Home</a> |
          <a href="{{ url_for('account') }}">My Account</a> |
          <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
          <a href="{{ url_for('login') }}">Login</a> |
          <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-content">
        <h1>Reality Club</h1>
        <p>one night, one story, endless memories.</p>
        {% if session.get('username') %}
          <div class="welcome-message">
            Welcome back, {{ session['username'] }}! Ready for some magical concerts?
          </div>
        {% endif %}
      </div>
    </section>

    <!-- World Tour Section -->
    <section class="tour-section">
      <h2>Indonesia Tour 2025</h2>
      <p>Reality Club: A night to remember<br>by PBL RKS 306</p>
    </section>

    <!-- Events Grid -->
    <section class="events-section">
        <div class="events-grid">
            {% for event in events %}
            <div class="event-card">
                <h3 class="event-name">{{ event.name }}</h3>
                <p class="event-location">{{ event.location }}</p>
                
                <div class="event-date">
                    üóìÔ∏è {{ event.event_date.strftime('%A, %d %B %Y') }}
                </div>
                <div class="event-status">
                    Status: <span class="status-{{ event.status|lower }}">{{ event.status }}</span>
                </div>
                
                <!-- Available Tickets -->
                <div class="tickets-section">
                    <p class="tickets-title">Available Tickets</p>
                    
                    {% for ticket in event.tickets %}
                    <div class="ticket-item">
                        <div class="ticket-info">
                            <span class="ticket-type">{{ ticket.type_name }}</span>
                            <span class="ticket-price">Rp {{ "{:,.0f}".format(ticket.price) }}</span>
                        </div>
                        <span class="ticket-stock {% if ticket.available > 10 %}high{% elif ticket.available > 0 %}medium{% else %}sold-out{% endif %}">
                            {{ ticket.available }} left
                        </span>
                    </div>
                    {% endfor %}
                    
                    {% if not event.tickets %}
                    <p class="no-tickets">No tickets available yet</p>
                    {% endif %}
                </div>
                
                <!-- Find Tickets Button -->
                <button class="find-tickets-btn" onclick="openTicketModal({{ event.id }})">
                    Find Tickets
                </button>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Footer -->
    <footer>
      <h2 class="footer-title">Contact Person</h2>
      <div class="contact-info">
        <p>Jam kerja: Senin - Jumat, 09:00 - 17:00</p>
        <p>üìû <a href="tel:+62211234567">+62 21-1234-567</a></p>
        <p>‚úâÔ∏è <a href="mailto:info@guardiantix.com">info@guardiantix.com</a></p>
      </div>
      <p class="copyright">¬© 2024 GuardianTix ‚Äî All rights reserved.</p>
    </footer>

    <!-- Ticket Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTicketModal()">&times;</span>
            
            <h2 id="modalEventName">Select Tickets</h2>
            <p id="modalEventDetails"></p>
            
            <div id="ticketSelection">
                <p class="loading-text">Loading tickets...</p>
            </div>
            
            <div class="modal-footer">
                <p id="totalPrice">Total: Rp 0</p>
                <button onclick="proceedToCheckout()" class="checkout-btn">
                    Continue to Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        let selectedTickets = {};
        let currentEventId = null;
        let currentEventData = null;

        // Simpan data events dari backend
        const eventsData = [
            {% for event in events %}
            {
                id: {{ event.id }},
                name: "{{ event.name }}",
                location: "{{ event.location }}",
                event_date: "{{ event.event_date.strftime('%A, %d %B %Y') }}",
                status: "{{ event.status }}",
                tickets: [
                    {% for ticket in event.tickets %}
                    {
                        type_name: "{{ ticket.type_name }}",
                        price: {{ ticket.price }},
                        available: {{ ticket.available }}
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        function openTicketModal(eventId) {
            currentEventId = eventId;
            selectedTickets = {};
            
            currentEventData = eventsData.find(event => event.id === eventId);
            
            if (!currentEventData) {
                alert('Event not found!');
                return;
            }
            
            renderTicketModal(currentEventData.tickets, eventId);
        }

        function renderTicketModal(tickets, eventId) {
            const modal = document.getElementById('ticketModal');
            const ticketSelection = document.getElementById('ticketSelection');
            
            document.getElementById('modalEventName').textContent = currentEventData.name;
            document.getElementById('modalEventDetails').textContent = 
                `${currentEventData.location} ‚Ä¢ ${currentEventData.event_date}`;
            
            ticketSelection.innerHTML = '';
            
            if (tickets.length === 0) {
                ticketSelection.innerHTML = '<p class="no-tickets-modal">No tickets available for this event</p>';
                return;
            }
            
            tickets.forEach(ticket => {
                const ticketDiv = document.createElement('div');
                ticketDiv.className = 'ticket-option';
                ticketDiv.innerHTML = `
                    <div class="ticket-option-content">
                        <div class="ticket-details">
                            <h4>${ticket.type_name}</h4>
                            <p class="ticket-price-modal">Rp ${ticket.price.toLocaleString('id-ID')}</p>
                            <small class="stock-info">
                                ${ticket.available} tickets available
                            </small>
                        </div>
                        <div class="quantity-controls">
                            <button onclick="decreaseTicket('${ticket.type_name}', ${ticket.price})" class="qty-btn">-</button>
                            <span id="qty-${ticket.type_name}" class="quantity">0</span>
                            <button onclick="increaseTicket('${ticket.type_name}', ${ticket.price}, ${ticket.available})" class="qty-btn">+</button>
                        </div>
                    </div>
                `;
                ticketSelection.appendChild(ticketDiv);
            });
            
            modal.style.display = 'block';
            updateTotal();
        }

        function increaseTicket(type, price, available) {
            const currentQty = selectedTickets[type] || 0;
            if (currentQty < available) {
                selectedTickets[type] = currentQty + 1;
                document.getElementById(`qty-${type}`).textContent = selectedTickets[type];
                updateTotal();
            } else {
                alert(`Only ${available} ${type} tickets available!`);
            }
        }

        function decreaseTicket(type, price) {
            const currentQty = selectedTickets[type] || 0;
            if (currentQty > 0) {
                selectedTickets[type] = currentQty - 1;
                document.getElementById(`qty-${type}`).textContent = selectedTickets[type];
                updateTotal();
            }
        }

        function updateTotal() {
            let total = 0;
            for (const [type, qty] of Object.entries(selectedTickets)) {
                const ticket = currentEventData.tickets.find(t => t.type_name === type);
                if (ticket) {
                    total += qty * ticket.price;
                }
            }
            document.getElementById('totalPrice').textContent = `Total: Rp ${total.toLocaleString('id-ID')}`;
        }

        function closeTicketModal() {
            document.getElementById('ticketModal').style.display = 'none';
            selectedTickets = {};
            currentEventId = null;
            currentEventData = null;
        }

        function proceedToCheckout() {
            const totalTickets = Object.values(selectedTickets).reduce((sum, qty) => sum + qty, 0);
            
            if (totalTickets === 0) {
                alert('Please select at least one ticket.');
                return;
            }
            
            const confirmPurchase = confirm(`Confirm purchase of ${totalTickets} ticket(s) for ${currentEventData.name}?\nTotal: Rp ${document.getElementById('totalPrice').textContent.split('Rp ')[1]}`);
            if (!confirmPurchase) return;
            
            const checkoutBtn = document.querySelector('.checkout-btn');
            const originalText = checkoutBtn.textContent;
            checkoutBtn.textContent = 'Processing...';
            checkoutBtn.disabled = true;
            
            fetch('/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    event_id: currentEventId,
                    tickets: selectedTickets
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('üéâ ' + data.message);
                    closeTicketModal();
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    alert('‚ùå Purchase failed: ' + data.error);
                    checkoutBtn.textContent = originalText;
                    checkoutBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Checkout error:', error);
                alert('‚ùå Network error. Please try again.');
                checkoutBtn.textContent = originalText;
                checkoutBtn.disabled = false;
            });
        }

        window.onclick = function(event) {
            const modal = document.getElementById('ticketModal');
            if (event.target === modal) {
                closeTicketModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeTicketModal();
            }
        });
    </script>

</body>
</html>